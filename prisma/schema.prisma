// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - tracks all passengers/users with their profile
model User {
  id                Int      @id @default(autoincrement())
  jid               String?  @unique  // WhatsApp JID (phone-based: xxx@s.whatsapp.net)
  lid               String?  @unique  // WhatsApp LID (linked account: xxx@lid)
  name              String?
  phone             String?
  reputation        Float?   // Average rating from drivers (1.0 to 5.0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  taxiRides         TaxiRide[]        @relation("UserRides")
  natalRides        NatalRide[]       @relation("UserNatalRides")
  ratingsGiven      Rating[]          @relation("RatingsGiven")
  ratingsReceived   Rating[]          @relation("RatingsReceived")

  @@index([jid])
  @@index([lid])
  @@map("users")
}

// Driver model - tracks all drivers
model Driver {
  id                Int      @id @default(autoincrement())
  jid               String?  @unique  // WhatsApp JID (phone-based: xxx@s.whatsapp.net)
  lid               String?  @unique  // WhatsApp LID (linked account: xxx@lid)
  name              String?
  phone             String?
  cpf               String?  @unique  // Brazilian CPF (Tax ID) - upgraded to unique for driver lookup
  email             String?  // Email address
  isActive          Boolean  @default(true)
  isTaxiDriver      Boolean  @default(false)
  isMotoTaxiDriver  Boolean  @default(false)
  reputation        Float?   // Average rating from passengers (1.0 to 5.0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  rideAssignments   RideAssignment[]
  ratingsGiven      Rating[]          @relation("DriverRatingsGiven")
  ratingsReceived   Rating[]          @relation("DriverRatingsReceived")

  @@index([jid])
  @@index([lid])
  @@index([cpf])
  @@index([isTaxiDriver])
  @@index([isMotoTaxiDriver])
  @@map("drivers")
}

// TaxiRide model - tracks taxi/mototaxi ride requests
model TaxiRide {
  id                Int      @id @default(autoincrement())
  status            String   // 'pending', 'completed', 'expired', 'cancelled'
  vehicleType       String   // 'taxi' or 'mototaxi'
  language          String   // 'en' or 'pt'

  // User reference
  userId            Int
  user              User     @relation("UserRides", fields: [userId], references: [id])

  // Location details
  locationText      String?
  locationLat       Float?
  locationLng       Float?
  destination       String?
  identifier        String?  // Visual identifier
  waitTime          String?  // Minutes

  // Retry tracking
  retryAttempts     Int      @default(0)  // Number of times passenger retried after expiration

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  completedAt       DateTime?
  expiredAt         DateTime?
  cancelledAt       DateTime?
  cancelledBy       String?  // 'user' or 'driver'
  feedbackSent      Boolean  @default(false)

  // Rating tracking - separate flags for passenger and driver
  passengerRatingRequestSent Boolean   @default(false)
  driverRatingRequestSent    Boolean   @default(false)
  ratingRequestSentAt        DateTime? // When rating requests were sent (2 hours after completion)
  ratingDeadlineAt           DateTime? // 24 hours after rating request sent

  // Relations
  assignment        RideAssignment?
  ratings           Rating[]

  @@index([status, createdAt])
  @@index([userId])
  @@index([ratingRequestSentAt])
  @@map("taxi_rides")
}

// RideAssignment - tracks driver assignments to rides
model RideAssignment {
  id                Int      @id @default(autoincrement())

  // Ride reference
  rideId            Int      @unique
  ride              TaxiRide @relation(fields: [rideId], references: [id], onDelete: Cascade)

  // Driver reference
  driverId          Int
  driver            Driver   @relation(fields: [driverId], references: [id])

  // Assignment timestamps
  acceptedAt        DateTime @default(now())
  cancelledAt       DateTime?

  @@index([driverId])
  @@map("ride_assignments")
}

// NatalRide model - tracks Natal airport ride-sharing offers
model NatalRide {
  id                Int      @id @default(autoincrement())
  direction         String   // 'toAirport' or 'fromAirport'
  datetime          DateTime // Scheduled travel time
  originalMsg       String   // Original message text

  // User reference
  userId            Int
  user              User     @relation("UserNatalRides", fields: [userId], references: [id])

  // Timestamps
  createdAt         DateTime @default(now())

  @@index([direction, datetime])
  @@index([userId])
  @@map("natal_rides")
}

// ConversationState model - tracks active taxi ride conversations
model ConversationState {
  id                     Int      @id @default(autoincrement())
  userJid                String   @unique  // WhatsApp JID

  // Conversation details
  state                  String   // Current state: 'awaiting_language', 'awaiting_name', etc.
  language               String?  // 'en' or 'pt'
  vehicleType            String?  // 'taxi' or 'mototaxi'
  skipUserInfo           Boolean  @default(false) // Whether to skip name/phone questions

  // Partial user info collected so far
  name                   String?
  phone                  String?
  locationText           String?
  locationLat            Float?
  locationLng            Float?
  destination            String?
  identifier             String?
  waitTime               String?

  // Ride ID if created
  rideId                 Int?

  // CPF validation tracking for driver acceptance
  cpfAttempts            Int      @default(0)  // Number of CPF validation attempts

  // Status tracking
  isActive               Boolean  @default(true)  // False when conversation is completed/expired
  completionReason       String?  // 'completed', 'timeout', 'cancelled', 'ride_accepted'

  // Timeout tracking
  conversationStartedAt  DateTime
  lastActivityAt         DateTime
  completedAt            DateTime?

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([userJid])
  @@index([isActive])
  @@index([lastActivityAt])
  @@map("conversation_states")
}

// Rating model - tracks ratings given after completed rides
model Rating {
  id                Int      @id @default(autoincrement())

  // Ride reference
  rideId            Int
  ride              TaxiRide @relation(fields: [rideId], references: [id], onDelete: Cascade)

  // Rater (who gave the rating) - can be passenger or driver
  raterType         String   // 'passenger' or 'driver'
  raterUserId       Int?     // If passenger rated
  raterUser         User?    @relation("RatingsGiven", fields: [raterUserId], references: [id])
  raterDriverId     Int?     // If driver rated
  raterDriver       Driver?  @relation("DriverRatingsGiven", fields: [raterDriverId], references: [id])

  // Ratee (who received the rating) - can be passenger or driver
  rateeType         String   // 'passenger' or 'driver'
  rateeUserId       Int?     // If passenger was rated
  rateeUser         User?    @relation("RatingsReceived", fields: [rateeUserId], references: [id])
  rateeDriverId     Int?     // If driver was rated
  rateeDriver       Driver?  @relation("DriverRatingsReceived", fields: [rateeDriverId], references: [id])

  // Rating value
  score             Int      // 1 to 5

  // Timestamps
  createdAt         DateTime @default(now())

  @@index([rideId])
  @@index([raterUserId])
  @@index([raterDriverId])
  @@index([rateeUserId])
  @@index([rateeDriverId])
  @@map("ratings")
}
